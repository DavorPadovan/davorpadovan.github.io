<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Relative Humidity Calculator</title>
  <meta name="description" content="Calculate the relative humidity inside after the outside air is warmed to your home temperature." />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />
  <!-- Consider adding integrity and crossorigin attributes for SRI -->
</head>
<body>
  <div class="container my-3">
    <h1 class="h3">Relative Humidity Calculator</h1>
    <p>The following calculator estimates the relative humidity of outside air after it is warmed to your inside temperature.</p>

    <form id="formdata" onsubmit="return false;" aria-describedby="calcHelp">
      <div id="calcHelp" class="sr-only">Enter outside temperature and humidity, and inside temperature. Result updates automatically.</div>

      <div class="row justify-content-center">
        <div class="col-md-4">
          <div class="form-group">
            <label for="outsideTemp">Outside Temperature (°C)</label>
            <div class="input-group input-group-lg">
              <input
                type="number"
                class="form-control"
                id="outsideTemp"
                name="outsideTemp"
                placeholder="Outside Temperature"
                inputmode="decimal"
                step="0.1"
                min="-100"
                max="100"
                aria-label="Outside temperature in degrees Celsius"
              />
              <div class="input-group-append">
                <span class="input-group-text">°C</span>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="form-group">
            <label for="outsideHumid">Outside Humidity (%)</label>
            <div class="input-group input-group-lg">
              <input
                type="number"
                class="form-control"
                id="outsideHumid"
                name="outsideHumid"
                placeholder="Outside Humidity"
                inputmode="decimal"
                step="0.1"
                min="0"
                max="100"
                aria-label="Outside relative humidity in percent"
              />
              <div class="input-group-append">
                <span class="input-group-text">%</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row justify-content-center">
        <div class="col-md-4">
          <div class="form-group">
            <label for="insideTemp">Inside Temperature (°C)</label>
            <div class="input-group input-group-lg">
              <input
                type="number"
                class="form-control"
                id="insideTemp"
                name="insideTemp"
                placeholder="Inside Temperature"
                inputmode="decimal"
                step="0.1"
                min="-100"
                max="100"
                aria-label="Inside temperature in degrees Celsius"
              />
              <div class="input-group-append">
                <span class="input-group-text">°C</span>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="form-group">
            <label for="insideHumid">Inside Humidity (%)</label>
            <div class="input-group input-group-lg">
              <input
                type="text"
                class="form-control"
                id="insideHumid"
                name="insideHumid"
                placeholder="Inside Humidity"
                readonly
                aria-live="polite"
                aria-label="Calculated inside humidity in percent"
              />
              <div class="input-group-append">
                <span class="input-group-text">%</span>
              </div>
            </div>
            <small class="form-text text-muted">Result is an estimate; values are rounded and clamped to 0–100%.</small>
          </div>
        </div>
      </div>
    </form>
  </div>

  <script>
    (function () {
      // Use 273.15 for Kelvin
      const KELVIN_OFFSET = 273.15;

      const outsideTempEl = document.getElementById('outsideTemp');
      const outsideHumidEl = document.getElementById('outsideHumid');
      const insideTempEl = document.getElementById('insideTemp');
      const insideHumidEl = document.getElementById('insideHumid');

      const inputs = [outsideTempEl, outsideHumidEl, insideTempEl];

      function parseNum(el) {
        const v = parseFloat(el.value);
        return Number.isFinite(v) ? v : null;
      }

      function clamp(v, min, max) {
        return Math.min(Math.max(v, min), max);
      }

      function computeHumidity() {
        const outsideTemp = parseNum(outsideTempEl);
        const outsideHumid = parseNum(outsideHumidEl);
        const insideTemp = parseNum(insideTempEl);

        if (outsideTemp === null || outsideHumid === null || insideTemp === null) {
          insideHumidEl.value = '';
          return;
        }

        // Reject impossible humidity inputs
        if (outsideHumid < 0 || outsideHumid > 100) {
          insideHumidEl.value = 'Outside humidity must be 0–100';
          return;
        }

        // Tetens formula (approx) for saturation vapor pressure (hPa)
        const satVapOut = 6.122 * Math.exp((17.62 * outsideTemp) / (243.12 + outsideTemp));
        const satVapIn = 6.122 * Math.exp((17.62 * insideTemp) / (243.12 + insideTemp));

        // Convert relative humidity (%) to mixing ratio / vapor pressure proportional term
        // Using the original formula structure but with Kelvin offset = 273.15
        // insideHumid = (T_in_K * RH_out * satVapOut) / (T_out_K * satVapIn)
        const insideHumidRaw = ((insideTemp + KELVIN_OFFSET) * outsideHumid * satVapOut) /
                               ((outsideTemp + KELVIN_OFFSET) * satVapIn);

        // Clamp and round to 1 decimal place
        const insideHumid = clamp(Math.round(insideHumidRaw * 10) / 10, 0, 100);

        insideHumidEl.value = insideHumid.toString();
      }

      // Listen to inputs and compute on input with small debounce
      let timeoutId = null;
      function onInput() {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(computeHumidity, 150);
      }

      inputs.forEach(i => i.addEventListener('input', onInput));
      // Initial compute if fields are prefilled
      computeHumidity();
    }());
  </script>
</body>
</html>